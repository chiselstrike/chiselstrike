# SPDX-FileCopyrightText: Â© 2022 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

cat << EOF > "$TEMPDIR/models/post.ts"
import { ChiselEntity } from "@chiselstrike/api";
export class Post extends ChiselEntity {
    author: OAuthUser;
}
EOF

cat << EOF > "$TEMPDIR/endpoints/user.js"
import { Post } from '../models/post.ts';
import { loggedInUser } from '@chiselstrike/api';
export default async function (req: Request) {
    const author = await loggedInUser() ?? { username: '' };
    await Post.build({ author }).save();
    return new Response('Successful save!');
}
EOF

cd "$TEMPDIR"
$CHISEL apply

$CURL -X POST $CHISELD_HOST/dev/user
# CHECK: Cannot save into type OAuthUser

token=`$CURL -s $CHISELD_HOST/__chiselstrike/auth/callback?user=aaa|sed -ne "s/.*chiselstrike_token=//" -e "s/<.*//p"`
$CURL -H "ChiselStrikeToken:$token" -X POST $CHISELD_HOST/dev/user
# CHECK: Successful save!

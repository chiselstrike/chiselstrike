# SPDX-FileCopyrightText: Â© 2022 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

cd "$TEMPDIR"

cat << EOF > "$TEMPDIR/endpoints/chisel.ts"
import { ChiselRequest, responseFromJson } from "@chiselstrike/api"

export default async function chisel(req: ChiselRequest) {
    const obj = { "path": req.pathParams, "version": req.version, "user": req.user?.username ?? "UNDEFINED", "endpoint": req.endpoint, "components": req.pathComponents().length };
    return responseFromJson(obj);
}
EOF

mkdir "$TEMPDIR/endpoints/chisel"
cat << EOF > "$TEMPDIR/endpoints/chisel/inner.ts"
import { ChiselRequest, responseFromJson } from "@chiselstrike/api"

export default async function chisel(req: ChiselRequest) {
    const obj = { "path": req.pathParams, "version": req.version, "user": req.user?.username ?? "UNDEFINED", "endpoint": req.endpoint, "components": req.pathComponents().length };
    return responseFromJson(obj);
}
EOF

$CHISEL apply
token_al=`$CURL -s $CHISELD_HOST/__chiselstrike/auth/callback?user=al|sed -ne "s/.*chiselstrike_token=//" -e "s/<.*//p"`

# overdo on extra / and make sure the path is sanitized on ChiselRequest
$CURL -H "ChiselStrikeToken:$token_al" $CHISELD_HOST/dev//////chisel////arg//
# CHECK: "path": "arg",
# CHECK: "version": "dev",
# CHECK: "user": "al",
# CHECK: "endpoint": "/chisel"
# CHECK: "components": 1

$CURL $CHISELD_HOST/dev//////chisel////arg//foo/bar
# CHECK: "path": "arg/foo/bar",
# CHECK: "user": "UNDEFINED",
# CHECK: "components": 3

$CURL $CHISELD_HOST/dev//////chisel////inner//foo/bar
# CHECK: "path": "foo/bar",
# CHECK: "components": 2

$CURL $CHISELD_HOST/dev/chisel/
# CHECK: "path": "",
# CHECK: "components": 0

$CURL $CHISELD_HOST/dev/chisel?query_path="Doesntshow"
# CHECK: "path": "",
# CHECK: "components": 0

# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

cp examples/person.ts "$TEMPDIR/types"
cp examples/csv.js examples/find.js "$TEMPDIR/endpoints"

cd "$TEMPDIR"
cat << EOF > "endpoints/foo.js"
export default async function my_req_func(req) {
    return new Response("v0");
}
EOF

$CHISEL apply --version __chiselstrike 2>&1 || echo
# CHECK: Error

$CHISEL apply --version v0
# CHECK: Type defined: Person
# CHECK: Type defined: Position
# CHECK: End point defined: /v0/csv
# CHECK: End point defined: /v0/find
# CHECK: End point defined: /v0/foo

cat << EOF > "endpoints/foo.js"
export default async function my_req_func(req) {
    return new Response("v1");
}
EOF

$CHISEL apply --version v1
# CHECK: Type defined: Person
# CHECK: Type defined: Position
# CHECK: End point defined: /v1/csv
# CHECK: End point defined: /v1/find
# CHECK: End point defined: /v1/foo

$CURL -o - $CHISELD_HOST/v0/foo
# CHECK: HTTP/1.1 200 OK
# CHECK: v0

$CURL -o - $CHISELD_HOST/v1/foo
# CHECK: HTTP/1.1 200 OK
# CHECK: v1

$CURL --data '
adam,smith
amanda,dodger
' $CHISELD_HOST/v0/csv

$CURL --data '
terry,stone
jill,lasalle
' $CHISELD_HOST/v1/csv

$CURL -o - $CHISELD_HOST/v0/find
# CHECK: HTTP/1.1 200 OK
# CHECK: adam smith 100 true 5 amanda dodger 100 true 5

$CURL -o - $CHISELD_HOST/v1/find
# CHECK: HTTP/1.1 200 OK
# CHECK: terry stone 100 true 5 jill lasalle 100 true 5

cat << EOF > "$TEMPDIR/policies/pol.yaml"
endpoints:
  - path: /find
    users: .*
EOF

$CHISEL apply --version v1

$CURL -o - $CHISELD_HOST/v0/find
# CHECK: HTTP/1.1 200 OK
# CHECK: adam smith 100 true 5 amanda dodger 100 true 5

$CURL -o - $CHISELD_HOST/v1/find
# CHECK: HTTP/1.1 403 Forbidden

$CHISEL delete --version v1
$CURL -o - $CHISELD_HOST/v0/find
# CHECK: HTTP/1.1 200 OK
# CHECK: adam smith 100 true 5 amanda dodger 100 true 5

$CURL -o - $CHISELD_HOST/v1/find
# CHECK: HTTP/1.1 404 Not Found

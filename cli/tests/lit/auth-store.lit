# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=alice
$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=bob
$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=charlie

cat << EOF > "$TEMPDIR/endpoints/users.ts"
export default async function chisel(req: Request) {
    let response = "";
    for await (let u of OAuthUser.cursor()) {
        response += u.username + " ";
    }
    return new Response(response);
}
EOF

cat << EOF > "$TEMPDIR/endpoints/trysave.ts"
export default async function chisel(req: Request) {
    let u = new OAuthUser();
    u.username = 'a';
    await u.save();
    return new Response('success!');
}
EOF

cd "$TEMPDIR"
$CHISEL apply
$CURL $CHISELD_HOST/dev/users
# CHECK: alice bob charlie
$CURL -XPOST $CHISELD_HOST/dev/trysave
# CHECK: Cannot save into type OAuthUser

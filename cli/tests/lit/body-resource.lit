# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: CHISEL="@chisel" CURL="@curl" sh -e @file

cat << EOF | $CHISEL end-point create --method=POST test1 -
async function chisel(req) {
    let res = Deno.core.resources();
    if (res[3] !== "chisel_server::deno::BodyResource") {
        throw "Missing resource";
    }
    let body = await req.text();
    if (body != "foobar") {
       throw "Wrong body";
    }
    res = Deno.core.resources();
    if (res[3] !== undefined) {
       throw "Body resource was not released";
    }
    return new Response("test1 is ok");
}
EOF

# CHECK: End point defined: /test1

$CURL --data foobar -o - localhost:3000/test1

# CHECK: HTTP/1.1 200 OK
# CHECK: test1 is ok

echo

cat << EOF | $CHISEL end-point create --method=POST test2 -
async function chisel(req) {
    let res = Deno.core.resources();
    if (res[4] !== "chisel_server::deno::BodyResource") {
        throw "Missing resource";
    }
    await req.body.cancel();
    res = Deno.core.resources();
    if (res[4] !== undefined) {
       throw "Body resource was not released";
    }
    return new Response("test2 is ok");
}
EOF

# CHECK: End point defined: /test2

$CURL --data foobar -o - localhost:3000/test2

# CHECK: HTTP/1.1 200 OK
# CHECK: test2 is ok

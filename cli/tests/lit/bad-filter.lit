# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

cp examples/person.ts "$TEMPDIR/models"

cat << EOF > "$TEMPDIR/endpoints/query.ts"
import { Person } from "../models/person.ts";

export default async function chisel(req: Request) {
    let ret = "";
    const filtered = await Person.findMany({"foo": "bar"});
    filtered.forEach(row => {
        ret += row.first_name + " " + row.last_name + "\n";
    });
    return new Response(ret);
}
EOF

cd "$TEMPDIR"
$CHISEL apply

# CHECK: Type defined: Person
# CHECK: End point defined: /dev/query

$CURL -o - $CHISELD_HOST/dev/query

# CHECK: HTTP/1.1 500 Internal Server Error
# CHECK: Uncaught Error: error returned from database: no such column: foo

# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

cp examples/person.ts "$TEMPDIR/types"

cat << EOF > "$TEMPDIR/endpoints/error.ts"
export default async function chisel(req: Request) {
    return new Response("foo" "bar");
}
EOF

cd "$TEMPDIR"

$CHISEL apply 2>&1 | $RMCOLOR || true
# CHECK: Error: parsing endpoint /dev/error
# CHECK: Caused by:
# CHECK:     Compilation failed:
# CHECK:     error.ts:2:31 - error TS1005: ',' expected.

cat << EOF > "$TEMPDIR/endpoints/error.ts"
const xyz = foo();
export default async function chisel(req: Request) {
    return xyz;
}
EOF

$CHISEL apply 2>&1 | $RMCOLOR || true
#CHECK: Error: parsing endpoint /dev/error
#CHECK: Caused by:
#CHECK:     Compilation failed:
#CHECK:     error.ts:1:13 - error TS2304: Cannot find name 'foo'.

cat << EOF > "$TEMPDIR/endpoints/error.ts"
export default async function chisel(req: Request) {
    const filtered = Person.findMany({"first_name": "bar"});
    let ret = "";
    for await (let row of filtered) {
        ret += row.nickname + "\n";
    }
    return new Response(ret);
}
EOF

$CHISEL apply 2>&1 | $RMCOLOR|| true
#CHECK: Error: parsing endpoint /dev/error
#CHECK: Caused by:
#CHECK:     Compilation failed:
#CHECK:     error.ts:5:20 - error TS2339: Property 'nickname' does not exist on type 'Person'.

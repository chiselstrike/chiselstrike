# SPDX-FileCopyrightText: Â© 2021-2022 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

cat << EOF > "$TEMPDIR/endpoints/foo.js"
export default async function chisel(req: Request) {
    return new Response("foo");
}
EOF

cat << EOF > "$TEMPDIR/endpoints/bar.js"
export default async function chisel(req: Request) {
    return new Response("bar", {
        headers: [
            ["access-control-allow-origin", "https://chiselstrike.com"],
            ["access-control-allow-methods", "get"],
            ["access-control-allow-headers", "foo"]
        ]
    });
}
EOF

cd "$TEMPDIR"
$CHISEL apply

# CHECK: End point defined: /dev/bar
# CHECK: End point defined: /dev/foo

$CURL -o - $CHISELD_HOST/dev/foo

# CHECK: HTTP/1.1 200 OK
# CHECK: access-control-allow-origin: *
# CHECK: access-control-allow-methods: POST, PUT, GET, OPTIONS
# CHECK: access-control-allow-headers: Content-Type
# CHECK: foo

echo

$CURL -o - $CHISELD_HOST/dev/bar

# CHECK: HTTP/1.1 200 OK
# CHECK: access-control-allow-headers: foo
# CHECK: access-control-allow-methods: get
# CHECK: access-control-allow-origin: https://chiselstrike.com
# CHECK: bar

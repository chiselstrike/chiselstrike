# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=alice
$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=bob
$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=charlie

cat << EOF > "$TEMPDIR/endpoints/users.ts"
export default async function chisel(req: Request) {
    let response = "";
    for await (let u of Chisel.OAuthUser.cursor()) {
        response += u.username + " ";
    }
    return new Response(response + '.');
}
EOF

cat << EOF > "$TEMPDIR/endpoints/trysave.ts"
export default async function chisel(req: Request) {
    let u = new Chisel.OAuthUser();
    u.username = 'a';
    await u.save();
    return new Response('success!');
}
EOF

cd "$TEMPDIR"
$CHISEL apply
$CURL $CHISELD_HOST/dev/users
# CHECK: alice bob charlie .
$CURL -XPOST $CHISELD_HOST/dev/trysave
# CHECK: Cannot save into type OAuthUser


## Reproduces #708:
$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=bob
$CURL $CHISELD_HOST/dev/users
# CHECK: alice bob charlie .

## Reproduces #710:
token=`$CURL -s $CHISELD_HOST/__chiselstrike/auth/callback?user=thoroughly-unique-username|sed -ne "s/.*chiselstrike_token=//" -e "s/<.*//p"`
$CURL -H "ChiselStrikeToken:$token" $CHISELD_HOST/__chiselstrike/auth/user
# CHECK: HTTP/1.1 200 OK
# CHECK: thoroughly-unique-username

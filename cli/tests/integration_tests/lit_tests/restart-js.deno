# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

cat << EOF > "$TEMPDIR/routes/test1.ts"
import { getSecret } from "@chiselstrike/api"

const issue728 = getSecret("somesecret");

function foo() {
    return "test OK"
}

export default async function chisel(req: Request) {
    return new Response(foo());
}
EOF

cd "$TEMPDIR"
$CHISEL apply
# CHECK: Applied:

$CURL -o - $CHISELD_HOST/dev/test1
# CHECK: HTTP/1.1 200 OK
# CHECK: test OK

echo

$CHISEL restart

# CHECK: Server restarted successfully.

cat << EOF > "$TEMPDIR/routes/test2.ts"
export default function chisel(req: Request): Response {
    // @ts-expect-error
    return new Response(foo());
}
EOF
$CHISEL apply
# CHECK: Applied:

$CURL -o - $CHISELD_HOST/dev/test2

# CHECK: HTTP/1.1 500 Internal Server Error
# CHECK: foo is not defined
